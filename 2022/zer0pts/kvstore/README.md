# kvstore  
[https://kileak.github.io/ctf/2022/zer0pts-kvstore/](https://kileak.github.io/ctf/2022/zer0pts-kvstore/)  
[https://hackmd.io/@ptr-yudai/r1jOWBvz9](https://hackmd.io/@ptr-yudai/r1jOWBvz9)  

after gets  
```
0x555555559470: 0x00007ffff7facf60      0x0000000000000101
0x555555559480: 0x4141414141414141      0x4141414141414141 <- add
0x555555559490: 0x4141414141414141      0x4141414141414141
0x5555555594a0: 0x4141414141414141      0x4141414141414141
0x5555555594b0: 0x4141414141414141      0x4141414141414141
0x5555555594c0: 0x4141414141414141      0x4141414141414141
0x5555555594d0: 0x4141414141414141      0x4141414141414141
0x5555555594e0: 0x4141414141414141      0x4141414141414141
0x5555555594f0: 0x4141414141414141      0x0000000000000000  <- size
0x555555559500: 0x00007ffff7fb0be0      0x00007ffff7fb0be0
0x555555559510: 0x0000000000000000      0x0000000000000000
0x555555559520: 0x4141414141414141      0x4141414141414141
0x555555559530: 0x4141414141414141      0x4141414141414141
0x555555559540: 0x4141414141414141      0x4141414141414141
0x555555559550: 0x4141414141414141      0x4141414141414141
0x555555559560: 0x4141414141414141      0x4141414141414141
0x555555559570: 0x4141414141414141      0x0000000000000101
0x555555559580: 0x4141414141414141      0x4141414141414141  <- gets
0x555555559590: 0x4141414141414141      0x4141414141414141
0x5555555595a0: 0x4141414141414141      0x4141414141414141
0x5555555595b0: 0x4141414141414141      0x4141414141414141
0x5555555595c0: 0x4141414141414141      0x4141414141414141
0x5555555595d0: 0x4141414141414141      0x4141414141414141
0x5555555595e0: 0x4141414141414141      0x4141414141414141
0x5555555595f0: 0x4141414141414141      0x0000000000000000
```
fseekもfreeすることがある。[ソース](https://elixir.bootlin.com/glibc/glibc-2.33/source/libio/fileops.c#L930)  
```c
  if (fp->_IO_buf_base == NULL)
    {
      /* It could be that we already have a pushback buffer.  */
      if (fp->_IO_read_base != NULL)
	{
	  free (fp->_IO_read_base);
	  fp->_flags &= ~_IO_IN_BACKUP;
	}
      _IO_doallocbuf (fp);
      _IO_setp (fp, fp->_IO_buf_base, fp->_IO_buf_base);
      _IO_setg (fp, fp->_IO_buf_base, fp->_IO_buf_base, fp->_IO_buf_base);
    }
```
`add -> fclose -> save -> add`だと`fp->_IO_read_base`がfree済みのチャンクを指しているため失敗する。  
