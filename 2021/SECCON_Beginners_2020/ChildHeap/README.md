# ChildHeap
libc 2.31  
Off By One + UAF    
### heap leak  
Off By Oneでサイズを書き換えてtcacheに繋ぐ  
```
0x0000000000000000  0x0000000000000021
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000111
0x0000000000000000  0x0000000000000000
　　　　　　　　　　↓
0x0000000000000000  0x0000000000000021
0x4141414141414141  0x4141414141414141  <- malloc(0x18)して書き換える  
0x4141414141414141  0x0000000000000100
0x0000000000000000  0x0000000000000000  <- malloc(0x108)してからfreeすると0x100のtcacheに繋がる   
```

### libc leak
上の手順で0x100のtcacheを埋める  
偽装チャンクをつくる  
```
0x0000000000000000  0x0000000000000051
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000051
    heap + 0x830        heap + 0x830    <- heap + 0x830
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000021
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000111
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000031
　　　　　　　　　　↓
0x0000000000000000  0x0000000000000051
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000051
    heap + 0x830        heap + 0x830    
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000021
0x4141414141414141  0x4141414141414141
0x0000000000000050  0x0000000000000100
0x4141414141414141  0x4141414141414141  <- ここをfreeすると上の偽装チャンクと結合される
0x4141414141414141  0x4141414141414141
0x4141414141414141  0x4141414141414141
0x4141414141414141  0x4141414141414141
                  ～
0x4141414141414141  0x0000000000000041
0x0000000000000000  0x0000000000000031
```
`malloc(0x28)`でunsorted binから切り出される  
`malloc(0)`では入力が行われないためリークできる  

### Overwrite `__free_hook`  
tcache poisningでfdを書き換える  
```
0x0000000000000000  0x0000000000000051
0x0000000000000000  0x0000000000000000  
0x0000000000000000  0x0000000000000031
0x0000000000000000  0x0000000000000000  
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000021
0x0000000000000000  0x0000000000000000
　　　　　　　　　　↓
0x0000000000000000  0x0000000000000051
0x4141414141414141  0x4141414141414141  <- malloc(0x48)して書き換える  
0x4141414141414141  0x0000000000000101
0x0000000000000000  0x0000000000000000  <- malloc(0x28)してからfreeすると0x100のtcacheに繋がる  
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000021
0x0000000000000000  0x0000000000000000
　　　　　　　　　　↓
0x0000000000000000  0x0000000000000051
0x4141414141414141  0x4141414141414141  <- malloc(0x48)して書き換える  
0x4141414141414141  0x0000000000000101
    __free_hook     0x0000000000000000  
0x0000000000000000  0x0000000000000000
0x0000000000000000  0x0000000000000021
0x0000000000000000  0x0000000000000000
```
この後に2回`malloc(0xf8)`すると`__free_hook`を書き換えられる  
